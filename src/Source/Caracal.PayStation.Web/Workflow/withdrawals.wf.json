{
  "name" : "withdrawals",
  "activities": [
    {
      "name": "start",
      "type": "api-activity",
      "next": "landing",
      "endpoints": [
        {
          "url": "[WITHDRAWAL_API]filter",
          "method": "POST",
          "headers": [
            {"content-type": "application/json"}
          ],
          "mappings":[
            {"client": "withdrawals.searchResult", "remote": "items", "direction": "in"}
          ]
        }
      ]
    },
    {
      "name": "landing",
      "type": "page-activity",
      "controls": [
        {"tag" : "apx-header", "caption": "Withdrawals" },
        {"tag":  "div",
          "style": "vertical-align:top;",
          "controls": [
            {"tag":  "h2", "innerHTML": "{{[translation_withdrawal_filter]}}" },
            {
              "tag": "apx-combo",
              "style": "width:33%;display:inline-block;vertical-align:top",
              "id": "withdrawals.searchStatus",
              "caption": "Status",
              "value": "",
              "items": [
                {"caption": "All", "value": ""},
                {"caption": "Requested", "value": "Requested"},
                {"caption": "Batched", "value": "Batched"},
                {"caption": "Flushed", "value": "Flushed"},
                {"caption": "Approved", "value": "Approved"},
                {"caption": "Processed", "value": "Processed"}
              ]
            },
            {"tag": "apx-date", "style": "width:33%;display:inline-block;vertical-align:top", "id": "demo.date", "caption": "Requested Date"},
            {"tag" : "hr" },
            {"tag" : "apx-button", "caption": "Filter", "next": "filter-grid", "isDefault": false }
          ]
        },
        {"tag":  "dcx-grid", 
          "caption":  "Withdrawal Results", 
          "id" : "withdrawals.searchResult", 
          "value":  ""},
        {"tag":  "div",
            "controls": [
            {
             "tag": "apx-combo",
             "id": "withdrawals.nextStatus",
             "caption": "Status",
             "items": [
               {"caption": "Requested", "value": "Requested"},
               {"caption": "Batched", "value": "Batched"},
               {"caption": "Flushed", "value": "Flushed"},
               {"caption": "Approved", "value": "Approved"},
               {"caption": "Processed", "value": "Processed"}
             ]
           },
           {"tag" : "hr" },
           {"tag" : "apx-button", "caption": "Update", "next": "update-state", "isDefault": true }
         ]
        }
      ]
    },

    {
      "name": "filter-grid",
      "type": "api-activity",
      "next": "apply-filter",
      "endpoints": [
        {
          "url": "[WITHDRAWAL_API]filter",
          "method": "POST",
          "headers": [
            {"content-type": "application/json"}
          ],
          "mappings":[
            {"client": "withdrawals.searchResult", "remote": "items", "direction": "in"}
          ]
        }
      ]
    },
    
    {
      "name": "apply-filter",
      "type": "code-activity",
      "next": "landing",
      "expression": "var status = ctx.model.getValue('withdrawals.searchStatus');if(status.length === 0) return; var items = ctx.model.getValue('withdrawals.searchResult'); ctx.model.setValue('withdrawals.searchResult', [...items.filter(i => i.status === status)]);"
    },
    {
      "name": "update-state",
      "type": "code-activity",
      "next": "update-state-api",
      "expression": "var nextStatus = ctx.model.getValue('withdrawals.nextStatus');var items = ctx.model.getValue('withdrawals.searchResult').filter(i => i.selected).map(i => {return { \"withdrawalId\": i.id, \"status\": nextStatus }});if(items.length > 0){ctx.model.setValue('withdrawals.status', [...items]);ctx.model.setValue('withdrawals.nextStatus','');}"
    },
    {
      "name": "update-state-api",
      "type": "api-activity",
      "next": "start",
      "endpoints": [
        {
          "url": "[WITHDRAWAL_API]status/change",
          "method": "POST",
          "headers": [
            {"content-type": "application/json"}
          ],
          "mappings":[
            {"client": "withdrawals.status", "remote": "items", "direction": "out"}
          ]
        }
      ]
    }
  ]
}
